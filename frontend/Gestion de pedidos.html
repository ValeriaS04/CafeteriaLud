<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cafeter√≠a JAVA</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>

<body>
  <!-- Encabezado -->
  <header>
    <h1><i class="fa-solid fa-mug-saucer" style="color: #ffffff;"></i> Cafeter√≠a JAVA</h1>
    <nav>
      <a href="Inicio.html">Inicio</a>
      <a href="#" class="activo">Pedidos</a>
      <a href="Inventario/inventario_menu.html">Inventario</a>
      <a href="Panel.html">Panel</a>
      <a href="Usuarios.html" id="linkUsuarios" style="display:none;">Usuarios</a>
      <a href="InicioSesion.html">Cerrar sesion</a>
    </nav>
  </header>

  <!-- Contenido principal -->
  <main class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="margin-bottom: 0;">Pedidos</h2>
      <button id="btnAddProduct" class="add" style="display:none; width: auto; padding: 10px 20px;">
        <i class="fa-solid fa-plus"></i> Agregar Producto
      </button>
    </div>

    <!-- Contenedor de tarjetas (se llenar√° din√°micamente) -->
    <div id="productsContainer" class="cards">
      <!-- Las tarjetas se generar√°n aqu√≠ con JavaScript -->
    </div>

    <div class="actions">
    
    </div>
  </main>

  <footer>
    <div class="footer-content">
      <p>¬© 2025 Cafeter√≠a JAVA. Todos los derechos reservados.</p>
      <div class="footer-links">
        <a href="politica_privacidad.html">Pol√≠tica de privacidad</a> |
        <a href="condiciones_servicio.html">Condiciones de servicio</a> |
        <a href="preguntas_frecuentes.html">Preguntas frecuentes</a>
      </div>
    </div>
  </footer>

  <!--modal-->
  <div id="resumenModal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h3>Resumen de Pedido</h3>
      <ul id="listaPedidoModal">
      </ul>
      <div class="modal-footer">
        <p><strong>Total:</strong> <span id="totalModal"></span></p>
      </div>
      <button id="seguirAgregando" class="add">A√±adir o Actualizar Productos</button>
      <button id="cerrarYConfirmar" class="report">Cerrar y Confirmar</button>
    </div>
  </div>
  <!--FinModal-->

  <!-- Modal Agregar Producto -->
   <div id="addProductModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close-add-product" style="float:right; font-size:28px; cursor:pointer;">&times;</span>
        <h3 style="color: #5a3d31; border-bottom: 2px solid #5a3d31; padding-bottom: 10px;">Agregar Nuevo Producto</h3>
        
        <form id="addProductForm" style="display: flex; flex-direction: column; gap: 10px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label style="font-weight: bold;">Nombre:</label>
                    <input type="text" id="newProdName" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label style="font-weight: bold;">Precio ($):</label>
                    <input type="number" id="newProdPrice" step="0.50" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label style="font-weight: bold;">Categor√≠a:</label>
                    <select id="newProdCategory" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div>
                    <label style="font-weight: bold;">Stock Inicial:</label>
                    <input type="number" id="newProdStock" value="0" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
            </div>

            <div>
                <label style="font-weight: bold;">Descripci√≥n:</label>
                <textarea id="newProdDesc" rows="2" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
            </div>

            <div>
                <label style="font-weight: bold;">URL Imagen:</label>
                <input type="url" id="newProdImage" placeholder="https://..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
            <h4 style="margin: 0; color: #6d4c41;">Receta (Ingredientes)</h4>
            <p style="font-size: 0.8em; color: #666; margin-bottom: 5px;">Define qu√© se descuenta del inventario al vender esto.</p>
            
            <div id="listaIngredientesContainer" style="max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 5px;">
                </div>
            
            <button type="button" id="btnAgregarIngrediente" style="background-color: #6c757d; color: white; border: none; padding: 5px; border-radius: 4px; cursor: pointer; margin-top: 5px;">
                + Agregar Ingrediente
            </button>
            <button type="submit" class="add" style="margin-top: 15px; width: 100%;">Guardar Producto</button>

            <a href="#" id="btnAbrirCrearInsumo" style="font-size: 0.9em; color: #28a745; text-decoration: underline;">
                ¬øNo encuentras el ingrediente? Cr√©alo aqu√≠
            </a>
        
        </form>
    </div>
  </div>
<<<<<<< HEAD
  <div id="clienteInitModal" class="modal" style="display: none;">
=======
<!--FinModal-->

  <div id="clienteInitModal" class="modal" style="display: flex;">
>>>>>>> 0c6214bb2ecdc8828f366d2bc056da42c6b592b4
    <div class="modal-content" style="max-width: 600px;">
        <h2 style="color: #6d4c41;">Seleccionar Cliente</h2>
        <p>Identifica la orden antes de comenzar.</p>
        
        <div id="estadoSeleccionado" style="display: none; background-color: #e8f5e9; padding: 15px; border-radius: 8px; border: 1px solid #a5d6a7; margin-bottom: 20px; text-align: center;">
            <p style="margin: 0; font-size: 1.1em; color: #2e7d32;">
                Cliente: <strong><span id="lblClienteSeleccionado"></span></strong>
            </p>
            <button id="btnCancelarSeleccion" style="margin-top: 10px; background: none; border: none; color: #c62828; text-decoration: underline; cursor: pointer;">
                Cambiar Cliente
            </button>
        </div>

        <div id="contenedorBusqueda">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" id="busquedaCliente" placeholder="Buscar cliente por nombre..." style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <button id="btnBuscarCliente" class="add" style="padding: 10px 15px;">üîç Buscar</button>
            </div>

            <div id="listaResultados" style="border: 1px solid #ddd; max-height: 120px; overflow-y: auto; display: none; margin-bottom: 15px; border-radius: 4px;">
                </div>

            <div class="form-group" style="border-top: 1px solid #eee; padding-top: 15px; margin-bottom: 15px;">
                <label for="selectMesaRapida" style="font-weight: bold;">O seleccionar Mesa R√°pida:</label>
                <select id="selectMesaRapida" style="width: 100%; padding: 10px; margin-top: 5px;">
                    <option value="">-- Seleccionar Mesa --</option>
                    <option value="1">Mesa 1</option>
                    <option value="2">Mesa 2</option>
                    <option value="3">Mesa 3</option>
                    <option value="4">Mesa 4</option>
                    <option value="5">Mesa 5</option>
                    <option value="6">Para Llevar/Barra</option>
                </select>
            </div>

            <div id="formNuevoCliente" style="display: none; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
                <h4 style="margin-top: 0; color: #d35400;">Registrar Nuevo Cliente</h4>
                <input type="text" id="nuevoNombreCliente" placeholder="Nombre completo" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <input type="email" id="nuevoEmailCliente" placeholder="Correo" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <button id="btnRegistrarCliente" class="ok" style="width: 100%;">Registrar y Seleccionar</button>
                <button id="btnCancelarRegistro" style="width: 100%; margin-top: 5px; background: none; border: none; color: #666; cursor: pointer;">Cancelar registro</button>
            </div>
        </div>

        <hr>

        <div style="margin-top: 20px; display: flex; justify-content: space-between; gap: 10px;">
            <button id="btnSalirPedidos" class="delete" style="background-color: #7f8c8d;">
                Salir al Inicio
            </button>
            <button id="btnConfirmarMesa" class="ok" disabled style="opacity: 0.5; cursor: not-allowed;">
                Confirmar y Continuar
            </button>
        </div>
    </div>
</div>

<input type="hidden" id="idClienteFinal">


// Modal para el insumo nuevo
<div id="modalQuickInsumo" class="modal" style="display: none; z-index: 2000;">
    <div class="modal-content" style="max-width: 450px; border: 2px solid #28a745;">
        <span class="close-btn" onclick="document.getElementById('modalQuickInsumo').style.display='none'">&times;</span>
        <h3 style="color: #28a745; margin-top: 0;">Nuevo Ingrediente</h3>
        
        <form id="formQuickInsumo">
            <div style="margin-bottom: 10px;">
                <label>Nombre:</label>
                <input type="text" id="qi_nombre" required style="width: 100%; padding: 8px;">
            </div>
            <div style="margin-bottom: 10px;">
                <label>Categor√≠a:</label>
                <select id="qi_categoria" style="width: 100%; padding: 8px;">
                    <option value="1">Bebidas (Ingrediente)</option>
                    <option value="2">Comidas (Ingrediente)</option>
                    <option value="3">Envases</option>
                </select>
            </div>
            <div style="margin-bottom: 10px;">
                <label>Stock Inicial:</label>
                <input type="number" id="qi_cantidad" value="0" required style="width: 100%; padding: 8px;">
            </div>
            <div style="margin-bottom: 10px;">
                <label>URL Imagen (Opcional):</label>
                <input type="text" id="qi_imagen" placeholder="https://..." style="width: 100%; padding: 8px;">
            </div>
            <button type="submit" class="add" style="width: 100%; background-color: #28a745;">Guardar Ingrediente</button>
        </form>
    </div>
</div>
// fin del modal

  <script>
//validacion encargado inventario
const userRole = localStorage.getItem('usuarioRol');

      if (userRole === 'Encargado de inventario') {
          // Encargado de Inventario (Debe ver: Inicio, Inventario, Cerrar Sesi√≥n)
          const pedidosLink = document.querySelector('nav a[href*="Gestion de pedidos.html"]');
          const panelLink = document.querySelector('nav a[href*="Panel.html"]');
          
          // 2. Restricci√≥n del Encargado: Ocultar Pedidos y Panel
          if (pedidosLink) pedidosLink.style.display = 'none';
          if (panelLink) panelLink.style.display = 'none';
      }
      //fin validacion
    // ==========================================
    // 1. VARIABLES GLOBALES
    // ==========================================
    let pedidoActual = [];
    let allProducts = [];
    let clienteSeleccionadoNombre = "";

    // Referencias DOM Globales
    const resumenModal = document.getElementById('resumenModal');
    const listaPedidoModal = document.getElementById('listaPedidoModal');
    const totalModal = document.getElementById('totalModal');
    const closeButton = document.querySelector('.close-button');
    const cerrarYConfirmarButton = document.getElementById('cerrarYConfirmar');
    const seguirAgregandoButton = document.getElementById('seguirAgregando');
    
    // Referencias Modal Cliente Inicial
    const clienteInitModal = document.getElementById('clienteInitModal');
    const inputBusqueda = document.getElementById('busquedaCliente');
    const btnBuscar = document.getElementById('btnBuscarCliente');
    const listaResultados = document.getElementById('listaResultados');
    const formNuevo = document.getElementById('formNuevoCliente');
    const selectMesaRapida = document.getElementById('selectMesaRapida');
    const btnRegistrar = document.getElementById('btnRegistrarCliente');
    const btnConfirmarMesa = document.getElementById('btnConfirmarMesa');
    const btnSalirPedidos = document.getElementById('btnSalirPedidos');
    const inputIdFinal = document.getElementById('idClienteFinal');
    
    // Referencias Modal Agregar Producto (Admin)
    const addProductModal = document.getElementById('addProductModal');
    const closeAddProduct = document.querySelector('.close-add-product');
    const addProductForm = document.getElementById('addProductForm');
    const categorySelect = document.getElementById('newProdCategory');
    const btnAddProduct = document.getElementById("btnAddProduct");


    // ==========================================
    // 2. FUNCIONES AUXILIARES
    // ==========================================

    // Funci√≥n: Limpiar pedido y resetear interfaz
    function cancelarPedidoYLimpiar(mostrarAlerta = true) {
        pedidoActual = [];
        document.querySelectorAll('.producto-cantidad').forEach(input => { input.value = 0; });
        document.querySelectorAll('.ok').forEach(button => {
            button.disabled = false;
            button.style.backgroundColor = '';
            button.style.cursor = 'pointer';
        });
        resumenModal.style.display = 'none';
       // alert('‚ùå Pedido Cancelado. El carrito ha sido vaciado.');
       if (mostrarAlerta) {
        alert('‚ùå Pedido Cancelado. El carrito ha sido vaciado.');
    }
      }
         
    // Funci√≥n: Mostrar Resumen de Pedido
function mostrarResumenPedido() {
    listaPedidoModal.innerHTML = '';
    let subtotal = 0;

    if (pedidoActual.length === 0) {
        listaPedidoModal.innerHTML = '<li>No hay productos en el pedido.</li>';
        totalModal.textContent = '$0.00';
    } else {
        pedidoActual.forEach(item => {
            const precioNumero = parseFloat(item.precio.replace('Precio: $', '').trim());
            const itemSubtotal = precioNumero * item.cantidad;
            subtotal += itemSubtotal;

            const li = document.createElement('li');
            li.innerHTML = `${item.nombre} (x${item.cantidad}) - $${precioNumero.toFixed(2)} c/u = $${itemSubtotal.toFixed(2)}`;
            listaPedidoModal.appendChild(li);
        });
        
        // üü¢ NUEVO: Calcular IVA y total
        const iva = subtotal * 0.16;
        const total = subtotal + iva;
        
        // üü¢ MODIFICADO: Mostrar desglose
        totalModal.innerHTML = `
            <div><strong>Subtotal:</strong> $${subtotal.toFixed(2)}</div>
            <div><strong>IVA (16%):</strong> $${iva.toFixed(2)}</div>
            <div style="font-size: 1.2em; margin-top: 5px;"><strong>Total:</strong> $${total.toFixed(2)}</div>
        `;
    }
    resumenModal.style.display = 'block';
}

    // Funci√≥n: Cargar productos del men√∫
    async function loadProducts() {
        try {
            const response = await fetch('http://localhost:3000/api/menu');
            if (!response.ok) throw new Error('Error al cargar el men√∫');
            allProducts = await response.json();
            renderProducts(allProducts);
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Error al cargar los productos.');
        }
    }

    // Funci√≥n: Renderizar tarjetas de productos
    function renderProducts(products) {
        const container = document.getElementById('productsContainer');
        container.innerHTML = '';
        products.forEach(product => {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.id = product.IdProducto;
            const imgSrc = product.ImagenUrl || 'https://via.placeholder.com/150?text=Sin+Imagen';
            card.innerHTML = `
                <img src="${imgSrc}" alt="${product.Nombre}" onerror="this.src='https://via.placeholder.com/150?text=Error+Imagen'">
                <h3 class="producto-nombre">${product.Nombre}</h3>
                <p class="producto-precio">Precio: $${product.Precio}</p>
                <div class="cantidad-control">
                    <label for="cantidad-${product.IdProducto}">Cantidad:</label>
                    <input type="number" value="0" min="0" class="producto-cantidad" id="cantidad-${product.IdProducto}">
                    <div class="buttons">
                        <button class="edit">‚úèÔ∏è</button>
                        <button class="ok">‚úî</button>
                        <button class="delete">‚ùå</button>
                    </div>
                </div>`;
            container.appendChild(card);
        });
    }

    // Funci√≥n: Actualizar estado del modal de cliente (Habilitar Confirmar)
    function actualizarEstadoConfirmar(id, nombre) {
        inputIdFinal.value = id;
        clienteSeleccionadoNombre = nombre;
        btnConfirmarMesa.disabled = false;
        btnConfirmarMesa.style.opacity = '1';
        btnConfirmarMesa.style.cursor = 'pointer';
        btnConfirmarMesa.textContent = `Confirmar ${nombre} y Continuar`;
        
        listaResultados.style.display = 'none';
        formNuevo.style.display = 'none';
    }


    // ==========================================
    // 3. EVENTOS Y L√ìGICA PRINCIPAL
    // ==========================================

    document.addEventListener('DOMContentLoaded', () => {
        // A. Carga Inicial
        loadProducts();
        
        // B. Control de Acceso (Rol)
        const userRole = localStorage.getItem('usuarioRol');
        if (userRole === 'Cajero/Mesero') {
             const inventarioLink = document.querySelector('nav a[href*="Inventario"]');
             if (inventarioLink) inventarioLink.style.display = 'none';
        }

        // C. Configuraci√≥n para Administrador (Bot√≥n Agregar Producto)
        if (userRole === "Administrador") {
            const linkUsuarios = document.getElementById("linkUsuarios");
            if (linkUsuarios) linkUsuarios.style.display = "inline-block";

            if (btnAddProduct) {
                btnAddProduct.style.display = "inline-block";
                
                // Evento Abrir Modal Admin
                btnAddProduct.addEventListener('click', async () => {
                    addProductModal.style.display = 'block';
                    if (categorySelect.options.length <= 1) {
                         try {
                            const res = await fetch('http://localhost:3000/api/categorias_menu');
                            if (res.ok) {
                                const categories = await res.json();
                                categorySelect.innerHTML = '<option value="">Seleccione una categor√≠a</option>';
                                categories.forEach(cat => {
                                    const option = document.createElement('option');
                                    option.value = cat.IdCategoria;
                                    option.textContent = cat.Nombre;
                                    categorySelect.appendChild(option);
                                });
                            }
                        } catch (e) { console.error(e); }
                    }
                });
            }
        }

        // D. Forzar Modal de Cliente al inicio
        /*if (!inputIdFinal.value) {
            clienteInitModal.style.display = 'flex';
        }*/
    });

    // --- EVENTOS MODAL CLIENTE ---

    // Buscar Cliente
    btnBuscar.addEventListener('click', async () => {
        const texto = inputBusqueda.value.trim();
        if (texto.length < 2) return alert("Escribe al menos 2 letras para buscar.");

        try {
            const res = await fetch(`http://localhost:3000/api/clientes/buscar?nombre=${encodeURIComponent(texto)}`);
            const clientes = await res.json();

            listaResultados.innerHTML = '';
            listaResultados.style.display = 'block';
            formNuevo.style.display = 'none';

            // Opci√≥n "Registrar Nuevo" siempre visible
            const divNuevo = document.createElement('div');
            divNuevo.innerHTML = `<em style="color:blue; font-weight:bold;">+ Registrar Nuevo Cliente</em>`;
            divNuevo.style.padding = '8px';
            divNuevo.style.cursor = 'pointer';
            divNuevo.onclick = () => { 
                formNuevo.style.display = 'block'; 
                listaResultados.style.display = 'none';
                document.getElementById('nuevoNombreCliente').value = texto;
            };
            listaResultados.appendChild(divNuevo);

            if (clientes.length > 0) {
                clientes.forEach(c => {
                    const div = document.createElement('div');
                    div.innerHTML = `<strong>${c.Nombre}</strong> <small>(${c.Email || 'Sin correo'})</small>`;
                    div.style.padding = '8px';
                    div.style.cursor = 'pointer';
                    div.style.borderBottom = '1px solid #eee';
                    div.onmouseover = () => div.style.background = '#f0f0f0';
                    div.onmouseout = () => div.style.background = 'white';
                    div.onclick = () => actualizarEstadoConfirmar(c.IdCliente, c.Nombre);
                    listaResultados.appendChild(div);
                });
            }
        } catch (error) {
            console.error('Error buscando cliente:', error);
        }
    });

    // Registrar Nuevo Cliente
    btnRegistrar.addEventListener('click', async () => {
        const nombre = document.getElementById('nuevoNombreCliente').value.trim();
        const email = document.getElementById('nuevoEmailCliente').value.trim();
        if(!nombre) return alert("El nombre es obligatorio.");
        if (!email) return alert("‚ö†Ô∏è El correo es obligatorio para nuevos clientes.");
        
        try {
            const res = await fetch('http://localhost:3000/api/clientes', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ nombre, email })
            });
            const data = await res.json();
            if(data.success) {
                actualizarEstadoConfirmar(data.id, data.nombre);
                alert(`‚úÖ Cliente registrado y seleccionado.`);
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) { console.error(error); }
    });

    // Selecci√≥n Mesa R√°pida
    selectMesaRapida.addEventListener('change', () => {
        const valor = selectMesaRapida.value;
        if (valor) {
            const texto = selectMesaRapida.options[selectMesaRapida.selectedIndex].text;
            actualizarEstadoConfirmar(valor, texto);
        }
    });

    // Confirmar y Cerrar Modal Cliente
    btnConfirmarMesa.addEventListener('click', () => {
        if (inputIdFinal.value) {
            clienteInitModal.style.display = 'none';
            // üö® CAMBIO CLAVE: Llama a la funci√≥n de confirmaci√≥n final
        // Esto evita que el usuario tenga que dar dos clics
        if (pedidoActual.length > 0) {
            // Simulamos el clic del bot√≥n de env√≠o final (cerrarYConfirmar)
            cerrarYConfirmarButton.click(); 
        } else {
            alert(`‚úÖ Cliente: ${clienteSeleccionadoNombre} seleccionado. A√±ade productos para finalizar.`);
        }
        }
    });
    
    // Salir de Pedidos
    btnSalirPedidos.addEventListener('click', () => {
        window.location.href = 'Inicio.html';
    });


    // --- EVENTOS MODAL RESUMEN PEDIDO ---

    closeButton.addEventListener('click', () => cancelarPedidoYLimpiar());
    
    window.addEventListener('click', (event) => {
        if (event.target === resumenModal) cancelarPedidoYLimpiar();
        if (event.target === addProductModal) addProductModal.style.display = 'none';
    });

    seguirAgregandoButton.addEventListener('click', () => {
        resumenModal.style.display = 'none';
    });

    // CONFIRMAR PEDIDO FINAL
    cerrarYConfirmarButton.addEventListener('click', async () => {
        if (pedidoActual.length === 0) {
            alert('El pedido est√° vac√≠o.');
            resumenModal.style.display = 'none';
            return;
        }
        
        const idCliente = inputIdFinal.value;
        if (!idCliente) {
            alert("‚ö†Ô∏è Error: No hay cliente seleccionado.");
            resumenModal.style.display = 'none';
            clienteInitModal.style.display = 'flex';
            return;
        }

        let total = 0;
        const productosParaDB = pedidoActual.map(item => {
            const precio = parseFloat(item.precio.replace('Precio: $', '').trim());
            const subtotal = precio * item.cantidad;
            total += subtotal;
            return { id: item.idProducto, cantidad: item.cantidad, subtotal: parseFloat(subtotal.toFixed(2)) };
        });

        const pedidoData = {
            idCliente: parseInt(idCliente, 10),
            idUsuario: parseInt(localStorage.getItem('usuarioId') || '1', 10),
            total: parseFloat(total.toFixed(2)),
            productos: productosParaDB,
            usuarioRol: localStorage.getItem('usuarioRol')
        };

        try {
            const response = await fetch('http://localhost:3000/api/pedidos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pedidoData)
            });
            const data = await response.json();

            if (response.ok && data.success) {
                alert(`‚úÖ Pedido #${data.idPedido} guardado con √©xito.`);
                cancelarPedidoYLimpiar(false); // Limpieza completa (false = no alerta)
            } else {
                alert(`‚ùå Error: ${data.message}`);
            }
        } catch (error) {
            console.error(error);
            alert('‚ùå Error de conexi√≥n.');
        }
    });


    // --- EVENTOS TARJETAS PRODUCTO (DELEGACI√ìN) ---
    
    document.getElementById('productsContainer').addEventListener('click', (e) => {
        const target = e.target;
        const card = target.closest('.card');
        if (!card) return;

        // OK BUTTON
        if (target.classList.contains('ok')) {
            if (target.disabled) return; // Evitar doble click si ya est√° deshabilitado

            const idProducto = parseInt(card.dataset.id, 10);
            const nombre = card.querySelector('.producto-nombre').textContent.trim();
            const precio = card.querySelector('.producto-precio').textContent.trim();
            const cantidadInput = card.querySelector('.producto-cantidad');
            const cantidad = parseInt(cantidadInput.value, 10);

            if (cantidad < 1 || isNaN(cantidad)) return alert('Cantidad inv√°lida');

            const producto = { idProducto, nombre, precio, cantidad };
            const existente = pedidoActual.find(p => p.idProducto === idProducto);

            if (existente) {
                existente.cantidad += cantidad;
            } else {
                pedidoActual.push(producto);
                target.disabled = true;
                target.style.backgroundColor = '#ccc';
                target.style.cursor = 'default';
            }
            mostrarResumenPedido();
        }
        
        // EDIT BUTTON
        if (target.classList.contains('edit')) {
             const idProducto = parseInt(card.dataset.id, 10);
             const cantidadInput = card.querySelector('.producto-cantidad');
             const nuevaCantidad = parseInt(cantidadInput.value, 10);
             
             if (isNaN(nuevaCantidad) || nuevaCantidad < 1) return alert('Cantidad inv√°lida');

             const existente = pedidoActual.find(p => p.idProducto === idProducto);
             if (existente) {
                 existente.cantidad = nuevaCantidad;
                 mostrarResumenPedido();
                 alert('Cantidad actualizada.');
             } else {
                 alert('Producto no a√±adido a√∫n. Usa ‚úî primero.');
             }
        }

        // DELETE BUTTON
        if (target.classList.contains('delete')) {
             const idProducto = parseInt(card.dataset.id, 10);
             const index = pedidoActual.findIndex(p => p.idProducto === idProducto);
             
             if (index !== -1) {
                 pedidoActual.splice(index, 1);
                 mostrarResumenPedido();
                 alert('Eliminado del pedido.');
                 
                 // Reactivar bot√≥n OK
                 const okButton = card.querySelector('.ok');
                 if (okButton) {
                     okButton.disabled = false;
                     okButton.style.backgroundColor = '';
                     okButton.style.cursor = 'pointer';
                 }
             } else {
                 alert('Este producto no est√° en el pedido.');
             }
        }
    });

    // --- EVENTOS MODAL AGREGAR PRODUCTO (ADMIN) ---
    // =====================================================
    // L√ìGICA NUEVA: AGREGAR PRODUCTO + RECETA
    // =====================================================
    const modalAdd = document.getElementById('addProductModal');
    const btnOpenAdd = document.getElementById('btnAddProduct');
    const btnCloseAdd = document.querySelector('.close-add-product');
    const formAdd = document.getElementById('addProductForm');
    let listaInsumosGlobal = [];

    // 1. Cargar lista de insumos del servidor
    async function cargarInsumosSistema() {
        try {
            const res = await fetch('http://localhost:3000/api/inventario/insumos');
            listaInsumosGlobal = await res.json();
        } catch (e) { console.error("Error cargando insumos", e); }
    }

    // 2. Agregar fila visual de ingrediente
    function agregarFilaIngrediente() {
        const div = document.createElement('div');
        div.className = 'fila-ingrediente';
        div.style.display = 'flex';
        div.style.gap = '10px';
        div.style.marginBottom = '8px';

        let opciones = '<option value="">-- Insumo --</option>';
        listaInsumosGlobal.forEach(insumo => {
            opciones += `<option value="${insumo.IdInventario}">${insumo.NombreProducto}</option>`;
        });

        div.innerHTML = `
            <select class="sel-insumo" style="flex: 2; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">${opciones}</select>
            <input type="number" class="inp-cantidad" placeholder="Cant. (ej: 0.250)" step="0.001" style="flex: 1; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
            <button type="button" onclick="this.parentElement.remove()" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 0 10px; cursor: pointer;">&times;</button>
        `;
        document.getElementById('listaIngredientesContainer').appendChild(div);
    }

    // 3. Abrir Modal
    if(btnOpenAdd) {
        btnOpenAdd.addEventListener('click', async () => {
            modalAdd.style.display = 'block';
            // Cargar insumos si es la primera vez
            if (listaInsumosGlobal.length === 0) await cargarInsumosSistema();
            
            // Limpiar y preparar
            document.getElementById('listaIngredientesContainer').innerHTML = '';
            agregarFilaIngrediente(); 
            
            // Cargar categor√≠as (Tu c√≥digo original para esto)
            const catSelect = document.getElementById('newProdCategory');
            if (catSelect && catSelect.options.length <= 1) {
                 try {
                    const res = await fetch('http://localhost:3000/api/categorias_menu');
                    if(res.ok) {
                        const cats = await res.json();
                        catSelect.innerHTML = '<option value="">Seleccione...</option>';
                        cats.forEach(c => {
                            const op = document.createElement('option');
                            op.value = c.IdCategoria; op.textContent = c.Nombre;
                            catSelect.appendChild(op);
                        });
                    }
                 } catch(e) {}
            }
        });
    }

    // 4. Cerrar Modal
    if(btnCloseAdd) btnCloseAdd.addEventListener('click', () => modalAdd.style.display = 'none');

    // 5. Bot√≥n "+ Agregar Ingrediente"
    const btnMasIng = document.getElementById('btnAgregarIngrediente');
    if(btnMasIng) btnMasIng.addEventListener('click', agregarFilaIngrediente);

    // 6. GUARDAR TODO (Submit)
    if(formAdd) {
        formAdd.addEventListener('submit', async (e) => {
            e.preventDefault();

            // A. Datos del Producto
            const productoData = {
                Nombre: document.getElementById('newProdName').value,
                Descripcion: document.getElementById('newProdDesc').value,
                Precio: parseFloat(document.getElementById('newProdPrice').value),
                Stock: parseInt(document.getElementById('newProdStock').value),
                IdCategoria: parseInt(document.getElementById('newProdCategory').value),
                Imagen: document.getElementById('newProdImage').value,
                Receta: [] 
            };

            // B. Datos de la Receta
            document.querySelectorAll('.fila-ingrediente').forEach(row => {
                const idInsumo = row.querySelector('.sel-insumo').value;
                const cantidad = row.querySelector('.inp-cantidad').value;
                if (idInsumo && cantidad) {
                    productoData.Receta.push({
                        IdInventario: parseInt(idInsumo),
                        CantidadInsumo: parseFloat(cantidad)
                    });
                }
            });

            // C. Enviar
            try {
                const res = await fetch('http://localhost:3000/api/inventario/productos-con-receta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productoData)
                });
                const data = await res.json();

                if (res.ok && data.success) {
                    alert('‚úÖ Producto guardado correctamente.');
                    modalAdd.style.display = 'none';
                    formAdd.reset();
                    loadProducts(); // Recargar la pantalla
                } else {
                    alert('‚ùå Error: ' + data.message);
                }
            } catch (error) {
                console.error(error);
                alert('Error de conexi√≥n');
            }
        });
    }


// --- L√ìGICA PARA CREAR INSUMO R√ÅPIDO ---
    const modalQuick = document.getElementById('modalQuickInsumo');
    const btnAbrirQuick = document.getElementById('btnAbrirCrearInsumo');
    const formQuick = document.getElementById('formQuickInsumo');

    // 1. Abrir el modal secundario
    if(btnAbrirQuick) {
        btnAbrirQuick.addEventListener('click', (e) => {
            e.preventDefault(); // Evitar que recargue
            modalQuick.style.display = 'flex';
        });
    }

    // 2. Guardar el nuevo insumo
    if(formQuick) {
        formQuick.addEventListener('submit', async (e) => {
            e.preventDefault();

            const nuevoInsumo = {
                nombre: document.getElementById('qi_nombre').value,
                categoria: parseInt(document.getElementById('qi_categoria').value),
                cantidad: parseFloat(document.getElementById('qi_cantidad').value),
                imagen: document.getElementById('qi_imagen').value || 'https://via.placeholder.com/150'
            };

            try {
                const res = await fetch('http://localhost:3000/api/inventario/nuevo-insumo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(nuevoInsumo)
                });

                if(res.ok) {
                    alert('‚úÖ Ingrediente creado.');
                    modalQuick.style.display = 'none';
                    formQuick.reset();

                    // 3. MAGIA: Recargar la lista de insumos y actualizar los selects abiertos
                    await cargarInsumosSistema(); 
                    actualizarSelectsAbiertos(); 
                } else {
                    alert('Error al guardar');
                }
            } catch (error) { console.error(error); }
        });
    }

    // 4. Funci√≥n auxiliar para actualizar los selects que ya est√°n en pantalla
    function actualizarSelectsAbiertos() {
        const selects = document.querySelectorAll('.sel-insumo');
        
        // Volvemos a generar el HTML de las opciones con la lista actualizada
        let nuevasOpciones = '<option value="">-- Insumo --</option>';
        listaInsumosGlobal.forEach(insumo => {
            nuevasOpciones += `<option value="${insumo.IdInventario}">${insumo.NombreProducto}</option>`;
        });

        // Aplicamos a todos los selects existentes
        selects.forEach(select => {
            const valorActual = select.value; // Guardamos lo que ten√≠a seleccionado
            select.innerHTML = nuevasOpciones;
            select.value = valorActual; // Restauramos la selecci√≥n (si exist√≠a)
        });
    }
</script>
  
</body>

</html>